import React, { useState, useMemo, useEffect, useRef } from 'react';
import { 
  Check, X, Briefcase, History, Edit2, Save, ArrowRight, Clock, 
  AlertCircle, Filter, RotateCcw, Calendar, ChevronRight, Zap,
  CheckCircle2, SlidersHorizontal, User
} from 'lucide-react';
import { LogStatus } from '../types';

// --- Helper Components ---

const TimelineComparison = ({ log }) => {
  const schedStart = log.schedulesStart;
  const schedEnd = log.schedulesEnd;

  // For history, show the FINAL adjusted time as the main "Actual" bar
  const actStart = log.actualStart || schedStart;
  const actEnd = log.actualEnd || schedEnd;

  // Calculate view range
  let minTime = new Date(Math.min(schedStart.getTime(), actStart.getTime()));
  let maxTime = new Date(Math.max(schedEnd.getTime(), actEnd.getTime()));

  // If we have original times that differ, include them in range calc
  if (log.editEndTime && log.editEndTime.getTime() > maxTime.getTime()) {
    maxTime = log.editEndTime;
  }

  // Padding
  minTime = new Date(minTime.getTime() - 30 * 60000);
  maxTime = new Date(maxTime.getTime() + 30 * 60000);

  const totalDuration = maxTime.getTime() - minTime.getTime();
  const getPos = (d) => ((d.getTime() - minTime.getTime()) / totalDuration) * 100;
  const getWidth = (s, e) => Math.max(1, getPos(e) - getPos(s));

  const actDuration = actEnd.getTime() - actStart.getTime();
  const schedDuration = schedEnd.getTime() - schedStart.getTime();
  const isOvertime = actDuration > schedDuration + 30 * 60000;

  const actStartDisplay = log.editStartTime? log.editStartTime : actStart;
  const actEndDisplay = log.editEndTime? log.editEndTime : actEnd;

  const barColor = isOvertime ? 'bg-amber-500' : 'bg-indigo-500';

  return (
    <div className="flex flex-col w-full mt-2">
      <div className="relative h-14 w-full bg-gray-50 rounded-lg border border-gray-100 overflow-hidden">
        {/* Grid lines */}
        {Array.from({ length: 12 }).map((_, i) => {
          const t = new Date(minTime.getTime() + i * 60 * 60000);
          if (t > maxTime) return null;
          return (
            <div key={i} className="absolute top-0 bottom-0 w-px bg-gray-200 opacity-50" style={{ left: `${getPos(t)}%` }}></div>
          );
        })}

        {/* Scheduled Bar (Top) */}
        <div
          className="absolute top-2 h-2.5 bg-gray-300 rounded-sm opacity-60"
          style={{ left: `${getPos(schedStart)}%`, width: `${getWidth(schedStart, schedEnd)}%` }}
        ></div>
        <span className="absolute top-1 text-[9px] text-gray-500 font-medium ml-1" style={{ left: `${getPos(schedEnd)}%` }}></span>

        {/* Actual Bar (Middle/Bottom) */}
        <div
          className={`absolute top-6 h-3.5 rounded-md shadow-sm ${barColor} z-5`}
          style={{ left: `${getPos(actStartDisplay)}%`, width: `${getWidth(actStartDisplay, actEndDisplay)}%` }}
        ></div>

        {/* Edited Time Adjustment (if any) */}
        {
          log.editStartTime && log.editStartTime - actStart > 0 ? (
            <div
              className="absolute top-6 h-3.5 bg-red-400/30 border border-red-300 border-dashed rounded-md z-2"
              style={{ left: `${getPos(actStart)}%`, width: `${getWidth(actStart, log.editStartTime)}%` }}
            >
            </div>
          ) : log.editStartTime && log.editStartTime - actStart < 0 ? (
            <div
              className="absolute top-6 h-3.5 bg-green-400/30 border border-green-300 border-dashed rounded-md z-2"
              style={{ left: `${getPos(log.editStartTime)}%`, width: `${getWidth(log.editStartTime, actStart)}%` }}
            >
            </div>
          ) : null
        }
        {
          log.editEndTime && log.editEndTime - actEnd > 0 ? (
            <div
              className="absolute top-6 h-3.5 bg-green-400/30 border border-green-300 border-dashed rounded-md z-2"
              style={{ left: `${getPos(actEnd)}%`, width: `${getWidth(actEnd, log.editEndTime)}%` }}
            >
            </div>
          ) : log.editEndTime && log.editEndTime - actEnd < 0 ? (
            <div
              className="absolute top-6 h-3.5 bg-red-400/30 border border-red-300 border-dashed rounded-md z-2"
              style={{ left: `${getPos(log.editEndTime)}%`, width: `${getWidth(log.editEndTime, actEnd)}%` }}
            >
            </div>
          ) : null
        }
        {/* {
          log.editEndTime && log.editStartTime && (
            <div
              className="absolute top-6 h-3.5 bg-red-400/30 border border-red-300 border-dashed rounded-md z-2"
              style={{
                left: `${getPos(log.editStartTime)}%`,
                width: `${getWidth(log.editStartTime, log.editEndTime)}%`
              }}
              title={`Original Claim: ${log.editEndTime.toLocaleTimeString()}`}
            ></div>
          )
        } */}

        {/* Original Claimed Time (Ghost Bar) - Only if different */}
        {/* {isHistory && log.editEndTime && log.editEndTime.getTime() !== actEnd.getTime() && (
            <div 
                className="absolute top-6 h-3.5 bg-red-200/50 border border-red-300 border-dashed rounded-md z-0"
                style={{ 
                    left: `${getPos(log.editStartTime || actStart)}%`, 
                    width: `${getWidth(log.editStartTime || actStart, log.editEndTime)}%` 
                }}
                title={`Original Claim: ${log.editEndTime.toLocaleTimeString()}`}
            ></div>
        )} */}

        <span className={`absolute top-6 text-[9px] font-bold ml-1 ${isOvertime ? 'text-amber-600' : 'text-indigo-600'}`} style={{ left: `${getPos(actEnd)}%` }}>
          {/* {isHistory ? 'Adjusted' : 'Actual'} */}
        </span>
      </div>
    </div>
  );
};

const DraggableTimeline = ({ log, editStartTime, editEndTime, onTimeChange }) => {
  const [isDragging, setIsDragging] = useState(null); // 'start', 'end', or 'both'
  const [dragStartX, setDragStartX] = useState(0);
  const [initialTimes, setInitialTimes] = useState({ start: null, end: null });
  const timelineRef = React.useRef(null);

  const schedStart = log.schedulesStart;
  const schedEnd = log.schedulesEnd;

  // Parse current edit times
  const parseEditTime = (timeStr, baseDate) => {
    if (!timeStr || !baseDate) return baseDate;
    const [h, m] = timeStr.split(':').map(Number);
    const result = new Date(baseDate);
    result.setHours(h, m, 0, 0);
    return result;
  };

  const actStart = parseEditTime(editStartTime, log.actualStart);
  const actEnd = parseEditTime(editEndTime, log.actualEnd);

  // Store original actual times for comparison
  const originalActStart = log.actualStart;
  const originalActEnd = log.actualEnd;

  // Calculate view range
  let minTime = new Date(Math.min(schedStart.getTime(), actStart.getTime(), originalActStart.getTime()));
  let maxTime = new Date(Math.max(schedEnd.getTime(), actEnd.getTime(), originalActEnd.getTime()));
  minTime = new Date(minTime.getTime() - 30 * 60000);
  maxTime = new Date(maxTime.getTime() + 30 * 60000);

  const totalDuration = maxTime.getTime() - minTime.getTime();
  const getPos = (d) => ((d.getTime() - minTime.getTime()) / totalDuration) * 100;
  const getWidth = (s, e) => Math.max(1, getPos(e) - getPos(s));

  const actDuration = actEnd.getTime() - actStart.getTime();
  const schedDuration = schedEnd.getTime() - schedStart.getTime();
  const isOvertime = actDuration > schedDuration + 30 * 60000;

  // Calculate overlap regions for visual feedback
  const overlapStart = new Date(Math.max(actStart.getTime(), originalActStart.getTime()));
  const overlapEnd = new Date(Math.min(actEnd.getTime(), originalActEnd.getTime()));
  const hasOverlap = overlapStart < overlapEnd;

  const formatTime = (date) => {
    if (!date) return '';
    const h = date.getHours().toString().padStart(2, '0');
    const m = date.getMinutes().toString().padStart(2, '0');
    return `${h}:${m}`;
  };

  const handleMouseDown = (e, handle) => {
    e.preventDefault();
    setIsDragging(handle);
    setDragStartX(e.clientX);
    setInitialTimes({ start: actStart, end: actEnd });
  };

  const handleMouseMove = (e) => {
    if (!isDragging || !timelineRef.current) return;

    const rect = timelineRef.current.getBoundingClientRect();
    const deltaX = e.clientX - dragStartX;
    const percentDelta = (deltaX / rect.width) * 100;
    const timeDelta = (percentDelta / 100) * totalDuration;

    let newStart = new Date(initialTimes.start.getTime());
    let newEnd = new Date(initialTimes.end.getTime());

    if (isDragging === 'start') {
      newStart = new Date(initialTimes.start.getTime() + timeDelta);
      // Round to nearest 15 minutes
      newStart.setMinutes(Math.round(newStart.getMinutes() / 15) * 15, 0, 0);
      // Don't allow start to go past end
      if (newStart >= newEnd) newStart = new Date(newEnd.getTime() - 15 * 60000);
    } else if (isDragging === 'end') {
      newEnd = new Date(initialTimes.end.getTime() + timeDelta);
      newEnd.setMinutes(Math.round(newEnd.getMinutes() / 15) * 15, 0, 0);
      // Don't allow end to go before start
      if (newEnd <= newStart) newEnd = new Date(newStart.getTime() + 15 * 60000);
    } else if (isDragging === 'both') {
      newStart = new Date(initialTimes.start.getTime() + timeDelta);
      newEnd = new Date(initialTimes.end.getTime() + timeDelta);
      newStart.setMinutes(Math.round(newStart.getMinutes() / 15) * 15, 0, 0);
      newEnd.setMinutes(Math.round(newEnd.getMinutes() / 15) * 15, 0, 0);
    }

    onTimeChange(formatTime(newStart), formatTime(newEnd));
  };

  const handleMouseUp = () => {
    setIsDragging(null);
  };

  React.useEffect(() => {
    if (isDragging) {
      window.addEventListener('mousemove', handleMouseMove);
      window.addEventListener('mouseup', handleMouseUp);
      return () => {
        window.removeEventListener('mousemove', handleMouseMove);
        window.removeEventListener('mouseup', handleMouseUp);
      };
    }
  }, [isDragging, dragStartX, initialTimes]);

  return (
    <div className="flex flex-col w-full mt-3">
      <div className="text-[10px] text-gray-500 mb-1.5 flex items-center gap-2">
        <span className="font-medium">üí° Drag the timeline handles or bars to adjust times</span>
      </div>
      <div
        ref={timelineRef}
        className={`relative h-16 w-full bg-gray-50 rounded-lg border-2 border-gray-200 overflow-visible ${isDragging ? 'cursor-grabbing' : ''}`}
      >
        {/* Grid lines */}
        {Array.from({ length: 12 }).map((_, i) => {
          const t = new Date(minTime.getTime() + i * 60 * 60000);
          if (t > maxTime) return null;
          return (
            <div key={i} className="absolute top-0 bottom-0 w-px bg-gray-300 opacity-40" style={{ left: `${getPos(t)}%` }}>
              <span className="absolute -bottom-4 left-0 text-[9px] text-gray-400 -translate-x-1/2">
                {t.getHours()}:00
              </span>
            </div>
          );
        })}

        {/* Scheduled Bar (Top) */}
        <div
          className="absolute top-2 h-2 bg-gray-400 rounded-sm opacity-50"
          style={{ left: `${getPos(schedStart)}%`, width: `${getWidth(schedStart, schedEnd)}%` }}
        ></div>

        {/* Original Actual Time - Shadow/Ghost Bar */}
        <div
          className="absolute top-7 h-5 bg-gray-400 rounded-md opacity-30"
          style={{ left: `${getPos(originalActStart)}%`, width: `${getWidth(originalActStart, originalActEnd)}%` }}
        ></div>

        {/* Adjusted Bar - with color coding */}
        <div
          className="absolute top-7 h-5 rounded-md shadow-md select-none"
          style={{ left: `${getPos(actStart)}%`, width: `${getWidth(actStart, actEnd)}%` }}
        >
          {/* Blue overlap section (within original time) */}
          {hasOverlap && (
            <div
              className="absolute h-full bg-indigo-600 rounded-md"
              style={{
                left: `${((overlapStart.getTime() - actStart.getTime()) / (actEnd.getTime() - actStart.getTime())) * 100}%`,
                width: `${((overlapEnd.getTime() - overlapStart.getTime()) / (actEnd.getTime() - actStart.getTime())) * 100}%`
              }}
            ></div>
          )}

          {/* Green extension on the left (adjusted start is earlier) */}
          {actStart < originalActStart && (
            <div
              className="absolute h-full bg-green-500 rounded-l-md"
              style={{
                left: '0%',
                width: `${((Math.min(originalActStart.getTime(), actEnd.getTime()) - actStart.getTime()) / (actEnd.getTime() - actStart.getTime())) * 100}%`
              }}
            ></div>
          )}

          {/* Green extension on the right (adjusted end is later) */}
          {actEnd > originalActEnd && (
            <div
              className="absolute h-full bg-green-500 rounded-r-md"
              style={{
                left: `${((Math.max(originalActEnd.getTime(), actStart.getTime()) - actStart.getTime()) / (actEnd.getTime() - actStart.getTime())) * 100}%`,
                width: `${((actEnd.getTime() - Math.max(originalActEnd.getTime(), actStart.getTime())) / (actEnd.getTime() - actStart.getTime())) * 100}%`
              }}
            ></div>
          )}

          {/* Draggable overlay for interaction */}
          <div
            className={`absolute inset-0 rounded-md ${!isDragging ? 'cursor-move hover:ring-2 hover:ring-indigo-400' : 'cursor-grabbing'}`}
            onMouseDown={(e) => handleMouseDown(e, 'both')}
          >
            {/* Start Handle */}
            <div
              className="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1/2 w-4 h-8 bg-white border-2 border-indigo-600 rounded-md cursor-ew-resize hover:bg-indigo-50 shadow-md z-10 flex items-center justify-center"
              onMouseDown={(e) => {
                e.stopPropagation();
                handleMouseDown(e, 'start');
              }}
            >
              <div className="w-0.5 h-4 bg-indigo-600 rounded"></div>
            </div>

            {/* End Handle */}
            <div
              className="absolute right-0 top-1/2 -translate-y-1/2 translate-x-1/2 w-4 h-8 bg-white border-2 border-indigo-600 rounded-md cursor-ew-resize hover:bg-indigo-50 shadow-md z-10 flex items-center justify-center"
              onMouseDown={(e) => {
                e.stopPropagation();
                handleMouseDown(e, 'end');
              }}
            >
              <div className="w-0.5 h-4 bg-indigo-600 rounded"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

const LogApprovalCard = ({ log, onApprove, onReject }) => {
  const [showRejectModal, setShowRejectModal] = useState(false);
  const [rejectReason, setRejectReason] = useState('');

  // Edit Mode State
  const [isEditing, setIsEditing] = useState(false);
  const [editStartTime, setEditStartTime] = useState(log.actualStart ? log.actualStart.toTimeString().slice(0, 5) : '');
  const [editEndTime, setEditEndTime] = useState(log.actualEnd ? log.actualEnd.toTimeString().slice(0, 5) : '');
  const [editReason, setEditReason] = useState('');

  const handleTimeChange = (newStart, newEnd) => {
    setEditStartTime(newStart);
    setEditEndTime(newEnd);
  };

  const handleSaveAndApprove = () => {
    if (!log.actualStart || !log.actualEnd) return;

    // Reconstruct Date objects from time strings
    const [startH, startM] = editStartTime.split(':').map(Number);
    const [endH, endM] = editEndTime.split(':').map(Number);

    const newStart = new Date(log.actualStart);
    newStart.setHours(startH, startM);

    const newEnd = new Date(log.actualEnd);
    newEnd.setHours(endH, endM);

    onApprove(log.id, newStart, newEnd, editReason || 'Manual adjustment');
  };

  const startDiff = log.actualStart ? (log.actualStart.getTime() - log.schedulesStart.getTime()) / 60000 : 0;
  const endDiff = log.actualEnd ? (log.actualEnd.getTime() - log.schedulesEnd.getTime()) / 60000 : 0;
  const hasIssues = startDiff > 10 || endDiff < -10 || endDiff > 15;

  const quickReasons = [
    'Timesheet incomplete',
    'Wrong project / job code',
    'Hours exceed schedule',
    'Policy breach ‚Äì needs clarification'
  ];

  return (
    <div className={`p-4 bg-white border-b border-gray-100 hover:bg-gray-50/50 transition-colors ${hasIssues ? 'bg-amber-50/10' : ''}`}>
      <div className="flex flex-col md:flex-row gap-4">
        {/* Worker Info */}
        <div className="w-full md:w-48 flex-shrink-0 flex items-center md:block gap-3">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold">
              {log.workerName.charAt(0)}
            </div>
            <div>
              <p className="font-semibold text-gray-900 text-sm">{log.workerName}</p>
              <p className="text-xs text-gray-500">{log.role}</p>
            </div>
          </div>
        </div>

        {/* Main Content */}
        <div className="flex-1 min-w-0">
          {!isEditing ? (
            <>
              <div className="flex flex-col sm:flex-row justify-between text-xs mb-1 gap-1">
                <span className="text-gray-400">Schedule vs Actual</span>
                <div className="flex flex-col sm:flex-row gap-1 sm:gap-4">
                  <span>
                    <span className="text-gray-400 mr-1">Act:</span>
                    <span className={`font-bold ${hasIssues ? 'text-amber-600' : 'text-indigo-600'}`}>
                      {log.actualStart?.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} - {log.actualEnd?.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                    </span>
                  </span>
                </div>
              </div>
              <TimelineComparison log={log} />
              {log.notes && (
                <div className="mt-2 text-xs text-gray-600 bg-gray-100 p-2 rounded italic">
                  "{log.notes}"
                </div>
              )}
            </>
          ) : (
            <div className="bg-indigo-50/50 p-4 rounded-lg border border-indigo-100">
              <div className="flex items-center gap-2 mb-3 text-indigo-700 font-medium text-sm">
                <Edit2 className="w-4 h-4" /> Adjust Time Log
              </div>

              {/* Interactive Timeline */}
              <DraggableTimeline
                log={log}
                editStartTime={editStartTime}
                editEndTime={editEndTime}
                onTimeChange={handleTimeChange}
              />

              {/* Manual Time Inputs */}
              <div className="mt-4 pt-4 border-t border-indigo-200">
                <div className="text-xs text-gray-600 mb-2 font-medium">Or enter times manually:</div>
                <div className="grid grid-cols-2 gap-4 mb-3">
                  <div>
                    <label className="text-xs text-gray-500 font-semibold uppercase">Start Time</label>
                    <input
                      type="time"
                      value={editStartTime}
                      onChange={(e) => setEditStartTime(e.target.value)}
                      className="w-full mt-1 p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-indigo-500"
                    />
                  </div>
                  <div>
                    <label className="text-xs text-gray-500 font-semibold uppercase">End Time</label>
                    <input
                      type="time"
                      value={editEndTime}
                      onChange={(e) => setEditEndTime(e.target.value)}
                      className="w-full mt-1 p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-indigo-500"
                    />
                  </div>
                </div>
              </div>

              <div>
                <label className="text-xs text-gray-500 font-semibold uppercase">Reason for Adjustment</label>
                <input
                  type="text"
                  placeholder="e.g. Lunch break not recorded, Policy adjustment..."
                  value={editReason}
                  onChange={(e) => setEditReason(e.target.value)}
                  className="w-full mt-1 p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-indigo-500"
                />
              </div>
              <div className="flex justify-end gap-2 mt-4">
                <button onClick={() => setIsEditing(false)} className="text-xs text-gray-500 hover:text-gray-700 px-3 py-2">Cancel</button>
                <button
                  onClick={handleSaveAndApprove}
                  className="flex items-center gap-1 bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded text-xs font-medium"
                >
                  <Save className="w-3 h-3" /> Save & Approve
                </button>
              </div>
            </div>
          )}
        </div>

        {/* Actions */}
        {!isEditing && (
          <div className="flex flex-row md:flex-col items-center gap-2 md:w-28 md:pl-4 md:border-l md:border-gray-100">
            <button onClick={() => onApprove(log.id)} className="w-full flex items-center justify-center gap-1 bg-green-50 text-green-700 hover:bg-green-100 p-2 rounded-lg text-xs font-medium transition-colors">
              <Check className="w-4 h-4" /> Approve
            </button>
            <button onClick={() => setIsEditing(true)} className="w-full flex items-center justify-center gap-1 bg-gray-50 text-gray-700 hover:bg-gray-100 p-2 rounded-lg text-xs font-medium transition-colors">
              <Edit2 className="w-4 h-4" /> Adjust
            </button>
            <button onClick={() => setShowRejectModal(true)} className="w-full flex items-center justify-center gap-1 bg-red-50 text-red-700 hover:bg-red-100 p-2 rounded-lg text-xs font-medium transition-colors">
              <X className="w-4 h-4" /> Reject
            </button>
          </div>
        )}
      </div>

      {showRejectModal && (
        <div className="fixed inset-0 z-40 flex items-center justify-center bg-black/40 p-4">
          <div className="bg-white rounded-xl shadow-2xl border border-gray-200 max-w-lg w-full p-6">
            <div className="flex items-start gap-3">
              <div className="mt-0.5">
                <X className="w-5 h-5 text-red-500" />
              </div>
              <div className="flex-1">
                <h3 className="text-lg font-semibold text-gray-900">Reject time entry</h3>
                <p className="text-sm text-gray-600 mt-1">Add a quick reason so the worker knows what to fix.</p>

                <div className="mt-4 grid grid-cols-2 gap-2">
                  {quickReasons.map(reason => (
                    <button
                      key={reason}
                      onClick={() => setRejectReason(reason)}
                      className="text-left text-xs px-3 py-2 border border-gray-200 rounded-lg hover:border-red-200 hover:bg-red-50/60 transition-colors"
                    >
                      {reason}
                    </button>
                  ))}
                </div>

                <label className="block text-xs font-semibold text-gray-700 mt-4 mb-1">Reason</label>
                <textarea
                  value={rejectReason}
                  onChange={(e) => setRejectReason(e.target.value)}
                  rows={3}
                  placeholder="e.g. Missing break time, shift overlaps another job, or add more detail"
                  className="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500"
                />

                <div className="flex justify-end gap-2 mt-4">
                  <button
                    onClick={() => { setShowRejectModal(false); setRejectReason(''); }}
                    className="text-sm text-gray-600 px-3 py-2 hover:text-gray-800"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={() => {
                      onReject(log.id, rejectReason || 'Rejected - no reason provided');
                      setShowRejectModal(false);
                      setRejectReason('');
                    }}
                    className="inline-flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-semibold"
                  >
                    <X className="w-4 h-4" /> Confirm Reject
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

const HistoryLogCard = ({ log }) => {
  // Check if adjusted
  const isAdjusted = log.editEndTime && log.actualEnd && log.editEndTime.getTime() !== log.actualEnd.getTime();

  // Format date
  const jobDate = log.actualStart || log.schedulesStart;
  const formattedDate = jobDate ? jobDate.toLocaleDateString('en-US', {
    weekday: 'short',
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  }) : '';

  return (
    <div className="p-4 bg-white border-b border-gray-100 hover:bg-gray-50 transition-colors">
      <div className="flex flex-col md:flex-row gap-4">
        <div className="w-full md:w-48 flex-shrink-0">
          <p className="font-semibold text-gray-900 text-sm">{log.workerName}</p>
          <p className="text-xs text-gray-500">{log.role}</p>

          <div className={`mt-2 inline-flex px-2 py-0.5 rounded-full text-[10px] font-bold uppercase border ${log.status === 'approved' ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-700 border-red-200'}`}>
            {log.status}
          </div>
        </div>

        <div className="flex-1 min-w-0">
          {/* Job Date - Top Right */}
          <div className="flex items-center justify-between mb-2">
            <div className="flex-1">
              {(isAdjusted || log.editReason) ? (
                <div className="bg-red-50 p-2 rounded border border-red-100 flex items-start gap-3">
                  <div className="mt-0.5">
                    <Edit2 className="w-3 h-3 text-red-600" />
                  </div>

                  <div className="text-xs text-red-800">
                    {isAdjusted && (
                      <div className="flex items-center gap-2 mb-1 font-medium">
                        <span className="text-gray-500 line-through decoration-red-400">
                          {log.actualStart?.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} -{" "}
                          {log.actualEnd?.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                        </span>

                        <ArrowRight className="w-3 h-3" />

                        <span>
                          {log.editStartTime?.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} -{" "}
                          {log.editEndTime?.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                        </span>
                      </div>
                    )}

                    {log.editReason && (
                      <p className="text-[11px]">
                        Notes: ‚Äú{log.editReason}‚Äù
                      </p>
                    )}
                  </div>
                </div>
              ) : (
                <div className="text-xs text-gray-600">
                  Actual:{" "}
                  <span className="font-medium">
                    {log.actualStart?.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} -{" "}
                    {log.actualEnd?.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                  </span>
                </div>
              )}
            </div>

            <div className="flex items-center gap-1.5 text-xs text-gray-600 ml-4">
              <Clock className="w-3 h-3" />
              <span>{formattedDate}</span>
            </div>
          </div>

          <TimelineComparison log={log} />

          <div className="mt-2 flex justify-between items-end">
            <p className="text-[10px] text-gray-400">
              {log.approvedAt
                ? `${log.status} at ${log.approvedAt.toLocaleDateString()} ${log.approvedAt.toLocaleTimeString()}`
                : ""}
            </p>
          </div>
        </div>
      </div>
    </div>
  );
};

export const ApprovalQueue = ({ logs, onApprove, onReject }) => {
  const [activeTab, setActiveTab] = useState('PENDING');
  const [selectedProjectId, setSelectedProjectId] = useState(null);
  const [historyProjectFilter, setHistoryProjectFilter] = useState('all');

  const pendingLogs = useMemo(() => logs.filter(l => l.status === LogStatus.WAITING_APPROVAL), [logs]);
  const historyLogs = useMemo(() => logs.filter(l => l.status === LogStatus.APPROVED || l.status === LogStatus.REJECTED).sort((a, b) => (b.actualEnd?.getTime() || 0) - (a.actualEnd?.getTime() || 0)), [logs]);

  console.log('History Logs:', historyLogs);

  // Get unique projects for pending
  const pendingProjects = useMemo(() => {
    const projectMap = new Map();
    pendingLogs.forEach(log => {
      if (!projectMap.has(log.projectId)) {
        projectMap.set(log.projectId, {
          id: log.projectId,
          name: log.projectName,
          count: 0,
          hasIssues: false
        });
      }
      const project = projectMap.get(log.projectId);
      project.count++;

      const startDiff = Math.abs((log.actualStart?.getTime() || 0) - log.schedulesStart.getTime()) / 60000;
      const endDiff = Math.abs((log.actualEnd?.getTime() || 0) - log.schedulesEnd.getTime()) / 60000;
      if (startDiff > 10 || endDiff > 15) {
        project.hasIssues = true;
      }
    });
    return Array.from(projectMap.values());
  }, [pendingLogs]);

  // Get unique projects for history filter
  const historyProjects = useMemo(() => {
    const projectMap = new Map();
    historyLogs.forEach(log => {
      if (!projectMap.has(log.projectId)) {
        projectMap.set(log.projectId, {
          id: log.projectId,
          name: log.projectName
        });
      }
    });
    return Array.from(projectMap.values());
  }, [historyLogs]);

  // Auto-select first project if none selected
  useEffect(() => {
    if (activeTab === 'PENDING' && pendingProjects.length > 0 && !selectedProjectId) {
      setSelectedProjectId(pendingProjects[0].id);
    }
  }, [activeTab, pendingProjects, selectedProjectId]);

  const selectedProjectLogs = useMemo(() => {
    if (!selectedProjectId) return [];
    return pendingLogs.filter(log => log.projectId === selectedProjectId);
  }, [pendingLogs, selectedProjectId]);

  const filteredHistoryLogs = useMemo(() => {
    if (historyProjectFilter === 'all') return historyLogs;
    return historyLogs.filter(log => log.projectId === historyProjectFilter);
  }, [historyLogs, historyProjectFilter]);

  const selectedProject = pendingProjects.find(p => p.id === selectedProjectId);

  return (
    <div className="space-y-6 pb-20 md:pb-0">
      {/* Tabs */}
      <div className="border-b border-gray-200 flex gap-6">
        <button
          onClick={() => setActiveTab('PENDING')}
          className={`pb-3 text-sm font-medium border-b-2 transition-colors flex items-center gap-2 ${activeTab === 'PENDING' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
        >
          <Clock className="w-4 h-4" />
          Pending Reviews
          {pendingLogs.length > 0 && <span className="bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full text-xs">{pendingLogs.length}</span>}
        </button>
        <button
          onClick={() => setActiveTab('HISTORY')}
          className={`pb-3 text-sm font-medium border-b-2 transition-colors flex items-center gap-2 ${activeTab === 'HISTORY' ? 'border-indigo-600 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
        >
          <History className="w-4 h-4" />
          History
          {historyLogs.length > 0 && <span className="bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full text-xs">{filteredHistoryLogs.length}</span>}
        </button>
      </div>

      {activeTab === 'PENDING' && (
        <>
          {pendingLogs.length === 0 ? (
            <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center mt-8">
              <div className="bg-green-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <Check className="w-8 h-8 text-green-500" />
              </div>
              <h3 className="text-xl font-semibold text-gray-900">All Caught Up!</h3>
              <p className="text-gray-500 mt-2">No pending time logs to approve.</p>
            </div>
          ) : (
            <div className="flex gap-6">
              {/* Left Sidebar - Project List */}
              <div className="w-80 flex-shrink-0">
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden sticky top-4">
                  <div className="bg-gradient-to-r from-indigo-50 to-purple-50 px-4 py-3 border-b border-gray-200">
                    <h3 className="font-bold text-gray-800 flex items-center gap-2">
                      <Briefcase className="w-4 h-4 text-indigo-600" />
                      Projects
                    </h3>
                  </div>

                  <div className="divide-y divide-gray-100 max-h-[600px] overflow-y-auto">
                    {pendingProjects.length === 0 ? (
                      <div className="p-8 text-center text-gray-400">
                        <Check className="w-12 h-12 mx-auto mb-2 text-green-400" />
                        <p className="text-sm">All caught up!</p>
                      </div>
                    ) : (
                      pendingProjects.map(project => (
                        <button
                          key={project.id}
                          onClick={() => setSelectedProjectId(project.id)}
                          className={`w-full text-left p-4 transition-colors ${selectedProjectId === project.id
                            ? 'bg-indigo-50 border-l-4 border-indigo-600'
                            : 'hover:bg-gray-50 border-l-4 border-transparent'
                            }`}
                        >
                          <div className="flex items-start justify-between gap-2">
                            <div className="flex-1 min-w-0">
                              <p className="font-semibold text-gray-900 truncate">{project.name}</p>
                              <p className="text-xs text-gray-500 mt-1">
                                {project.count} {project.count === 1 ? 'entry' : 'entries'}
                              </p>
                            </div>
                            <div className="flex items-center gap-2">
                              {project.hasIssues && (
                                <AlertCircle className="w-4 h-4 text-amber-500" />
                              )}
                              <span className={`px-2 py-1 rounded-full text-xs font-bold ${selectedProjectId === project.id
                                ? 'bg-indigo-600 text-white'
                                : 'bg-gray-200 text-gray-700'
                                }`}>
                                {project.count}
                              </span>
                            </div>
                          </div>
                        </button>
                      ))
                    )}
                  </div>
                </div>
              </div>

              {/* Right Side - Selected Project Details */}
              <div className="flex-1">
                {selectedProjectId && selectedProject ? (
                  <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div className="bg-gradient-to-r from-indigo-50 to-purple-50 px-6 py-4 border-b border-gray-200">
                      <div className="flex items-center justify-between">
                        <div>
                          <h3 className="text-xl font-bold text-gray-900">{selectedProject.name}</h3>
                          <p className="text-sm text-gray-600 mt-1">
                            {selectedProjectLogs.length} time {selectedProjectLogs.length === 1 ? 'entry' : 'entries'} pending approval
                          </p>
                        </div>
                        {selectedProject.hasIssues && (
                          <div className="bg-amber-100 text-amber-700 px-3 py-1.5 rounded-full text-xs font-semibold flex items-center gap-1">
                            <AlertCircle className="w-3 h-3" />
                            Has Issues
                          </div>
                        )}
                      </div>
                    </div>

                    <div className="divide-y divide-gray-100">
                      {selectedProjectLogs.map(log => (
                        <LogApprovalCard key={log.id} log={log} onApprove={onApprove} onReject={onReject} />
                      ))}
                    </div>
                  </div>
                ) : (
                  <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
                    <Briefcase className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                    <p className="text-gray-500">Select a project to view time entries</p>
                  </div>
                )}
              </div>
            </div>
          )}
        </>
      )}

      {activeTab === 'HISTORY' && (
        <div className="space-y-4">
          {/* Filter */}
          <div className="flex items-center gap-3 bg-white rounded-lg border border-gray-200 p-4">
            <Filter className="w-4 h-4 text-gray-500" />
            <label className="text-sm font-medium text-gray-700">Filter by Project:</label>
            <select
              value={historyProjectFilter}
              onChange={(e) => setHistoryProjectFilter(e.target.value)}
              className="flex-1 max-w-xs px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            >
              <option value="all">All Projects ({historyLogs.length})</option>
              {historyProjects.map(project => (
                <option key={project.id} value={project.id}>
                  {project.name} ({historyLogs.filter(l => l.projectId === project.id).length})
                </option>
              ))}
            </select>
          </div>

          {/* History Logs */}
          <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div className="bg-gray-50 px-4 py-3 border-b border-gray-200">
              <h3 className="font-bold text-gray-800">Recent Decisions</h3>
            </div>
            <div className="divide-y divide-gray-100">
              {filteredHistoryLogs.map(log => (
                <HistoryLogCard key={log.id} log={log} />
              ))}
              {filteredHistoryLogs.length === 0 && (
                <div className="p-8 text-center text-gray-400">No history available yet.</div>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};
